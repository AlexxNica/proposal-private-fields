<!doctype html>
<head><meta charset="utf-8">
<title>User-Defined Internal Slots</title><script type="application/json" id="menu-search-biblio">{"clauses":{"sec-introduction":{"location":"","id":"sec-introduction","aoid":null,"title":"Introduction","number":"1"},"sec-initialization":{"location":"","id":"sec-initialization","aoid":null,"title":"Allocation and Initialization","number":"2"},"sec-initializeinternalslots":{"location":"","id":"sec-initializeinternalslots","aoid":"InitializeInternalSlots","title":"InitializeInternalSlots ( _O_, _internalSlotList_ )","number":"2.1"},"sec-objectcreate":{"location":"","id":"sec-objectcreate","aoid":"ObjectCreate","title":"ObjectCreate ( _proto_ [ , _internalSlotsList_ ] )","number":"2.2"},"sec-ecmascript-function-objects-construct-argumentslist-newtarget":{"location":"","id":"sec-ecmascript-function-objects-construct-argumentslist-newtarget","aoid":null,"title":"[[Construct]] ( _argumentsList_, _newTarget_ )","number":"2.3"},"sec-super-keyword":{"location":"","id":"sec-super-keyword","aoid":null,"title":"The `super` Keyword","number":"2.4"},"sec-super-keyword-runtime-semantics-evaluation":{"location":"","id":"sec-super-keyword-runtime-semantics-evaluation","aoid":null,"title":"Runtime Semantics: Evaluation","number":"2.4.1"}},"ops":{"InitializeInternalSlots":{"aoid":"InitializeInternalSlots","id":"sec-initializeinternalslots","location":""},"ObjectCreate":{"aoid":"ObjectCreate","id":"sec-objectcreate","location":""}},"productions":{"prod-SuperCall":{"id":"prod-SuperCall","location":"","name":"SuperCall"}},"terms":{},"examples":{},"notes":{},"tables":{},"figures":{}}</script></head><body><div id="menu-toggle">☰</div><div id="menu"><div id="menu-search"><input type="text" id="menu-search-box" placeholder="Search..."><div id="menu-search-results" class="inactive"></div></div><div id="menu-toc"><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-introduction" title="Introduction"><span class="secnum">1</span> Introduction</a></li><li><span class="item-toggle">◢</span><a href="#sec-initialization" title="Allocation and Initialization"><span class="secnum">2</span> Allocation and Initialization</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-initializeinternalslots" title="InitializeInternalSlots ( _O_, _internalSlotList_ )"><span class="secnum">2.1</span> InitializeInternalSlots ( <var>O</var>, <var>internalSlotList</var> )</a></li><li><span class="item-toggle-none"></span><a href="#sec-objectcreate" title="ObjectCreate ( _proto_ [ , _internalSlotsList_ ] )"><span class="secnum">2.2</span> ObjectCreate ( <var>proto</var> [ , <var>internalSlotsList</var> ] )</a></li><li><span class="item-toggle-none"></span><a href="#sec-ecmascript-function-objects-construct-argumentslist-newtarget" title="[[Construct]] ( _argumentsList_, _newTarget_ )"><span class="secnum">2.3</span> [[Construct]] ( <var>argumentsList</var>, <var>newTarget</var> )</a></li><li><span class="item-toggle">◢</span><a href="#sec-super-keyword" title="The `super` Keyword"><span class="secnum">2.4</span> The <code>super</code> Keyword</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-super-keyword-runtime-semantics-evaluation" title="Runtime Semantics: Evaluation"><span class="secnum">2.4.1</span> RS: Evaluation</a></li></ol></li></ol></li></ol></div></div><h1 class="version">Stage 0 Draft / January 20, 2016</h1><h1 class="title">User-Defined Internal Slots</h1>
<script src="https://bterlson.github.io/ecmarkup/ecmarkup.js" defer=""></script>
<link rel="stylesheet" href="https://bterlson.github.io/ecmarkup/elements.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_light.min.css">

<emu-clause id="sec-introduction">
  <h1><span class="secnum">1</span>Introduction<span class="utils"><span class="anchor"><a href="#sec-introduction">#</a></span></span></h1>
  <emu-import href="./introduction.html"><p>This proposal add syntactic support for user-defined internal slots by means of private field declarations within class bodies.</p>

<p>See  <a href="https://github.com/zenparsing/es-private-fields">the proposal repository</a> for background material and discussion.</p>
</emu-import>
</emu-clause>

<emu-clause id="sec-initialization">
  <h1><span class="secnum">2</span>Allocation and Initialization<span class="utils"><span class="anchor"><a href="#sec-initialization">#</a></span></span></h1>
  <emu-import href="./initialization.html"><emu-clause id="sec-initializeinternalslots" aoid="InitializeInternalSlots">
  <h1><span class="secnum">2.1</span>InitializeInternalSlots ( <var>O</var>, <var>internalSlotList</var> )<span class="utils"><span class="anchor"><a href="#sec-initializeinternalslots">#</a></span></span></h1>
  <emu-alg><ol><li>For each element <var>slotKey</var> in <var>internalSlotList</var>,<ol><li>If <var>O</var> has an internal slot named <var>slotKey</var>, then<ol><li>Set the value of the internal slot named <var>slotKey</var> of <var>O</var> to <emu-val>undefined</emu-val>.</li></ol></li><li>Else,<ol><li>Create an internal slot name <var>slotKey</var> of <var>O</var> whose value is <emu-val>undefined</emu-val>.
  </li></ol></li></ol></li></ol></emu-alg>
</emu-clause>

<emu-clause id="sec-objectcreate" aoid="ObjectCreate">
  <h1><span class="secnum">2.2</span>ObjectCreate ( <var>proto</var> [ , <var>internalSlotsList</var> ] )<span class="utils"><span class="anchor"><a href="#sec-objectcreate">#</a></span></span></h1>
  <p>The abstract operation ObjectCreate with argument <var>proto</var> (an object or null) is used to specify the runtime creation of new ordinary objects. The optional argument <var>internalSlotsList</var> is a <emu-xref href="#sec-list-and-record-specification-type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-list-and-record-specification-type">List</a></emu-xref> of the names of additional internal slots that must be defined as part of the object. If the list is not provided, an empty <emu-xref href="#sec-list-and-record-specification-type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-list-and-record-specification-type">List</a></emu-xref> is used. This abstract operation performs the following steps:</p>
  <emu-alg><ol><li>If <var>internalSlotsList</var> was not provided, let <var>internalSlotsList</var> be an empty <emu-xref href="#sec-list-and-record-specification-type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>obj</var> be a newly created object.</li><li>Perform ! <emu-xref aoid="InitializeInternalSlots"><a href="#sec-initializeinternalslots">InitializeInternalSlots</a></emu-xref>(<var>internalSlotsList</var>).</li><li>Set <var>obj</var>'s essential internal methods to the default ordinary object definitions specified in <emu-xref href="#sec-ordinary-object-internal-methods-and-internal-slots"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ordinary-object-internal-methods-and-internal-slots">9.1</a></emu-xref>.</li><li>Set the [[Prototype]] internal slot of <var>obj</var> to <var>proto</var>.</li><li>Set the [[Extensible]] internal slot of <var>obj</var> to <emu-val>true</emu-val>.</li><li>Return <var>obj</var>.
  </li></ol></emu-alg>
</emu-clause>

<emu-clause id="sec-ecmascript-function-objects-construct-argumentslist-newtarget">
  <h1><span class="secnum">2.3</span>[[Construct]] ( <var>argumentsList</var>, <var>newTarget</var> )<span class="utils"><span class="anchor"><a href="#sec-ecmascript-function-objects-construct-argumentslist-newtarget">#</a></span></span></h1>
  <p>The [[Construct]] internal method for an ECMAScript Function object <var>F</var> is called with parameters <var>argumentsList</var> and <var>newTarget</var>. <var>argumentsList</var> is a possibly empty <emu-xref href="#sec-list-and-record-specification-type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-list-and-record-specification-type">List</a></emu-xref> of ECMAScript language values. The following steps are taken:</p>
  <emu-alg><ol><li>Assert: <var>F</var> is an ECMAScript function object.</li><li>Assert: <emu-xref aoid="Type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>newTarget</var>) is Object.</li><li>Let <var>callerContext</var> be the running <emu-xref href="#sec-execution-contexts"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-execution-contexts">execution context</a></emu-xref>.</li><li>Let <var>kind</var> be <var>F</var>'s [[ConstructorKind]] internal slot.</li><li>If <var>kind</var> is <code>"base"</code>, then<ol><li>Let <var>instanceSlots</var> be the value of <var>F</var>'s [[InstanceSlots]] internal slot.</li><li>Let <var>thisArgument</var> be ? <emu-xref aoid="OrdinaryCreateFromConstructor"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ordinarycreatefromconstructor">OrdinaryCreateFromConstructor</a></emu-xref>(<var>newTarget</var>, <code>"%ObjectPrototype%"</code>, <var>instanceSlots</var>).</li></ol></li><li>Let <var>calleeContext</var> be <emu-xref aoid="PrepareForOrdinaryCall"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-prepareforordinarycall">PrepareForOrdinaryCall</a></emu-xref>(<var>F</var>, <var>newTarget</var>).</li><li>Assert: <var>calleeContext</var> is now the running <emu-xref href="#sec-execution-contexts"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-execution-contexts">execution context</a></emu-xref>.</li><li>If <var>kind</var> is <code>"base"</code>, then<ol><li>NOTE: Private field initializers should be evaluated here.</li><li>Perform ! <emu-xref aoid="OrdinaryCallBindThis"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ordinarycallbindthis">OrdinaryCallBindThis</a></emu-xref>(<var>F</var>, <var>calleeContext</var>, <var>thisArgument</var>).</li></ol></li><li>Let <var>constructorEnv</var> be the LexicalEnvironment of <var>calleeContext</var>.</li><li>Let <var>envRec</var> be <var>constructorEnv</var>'s <emu-xref href="#sec-lexical-environments"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-lexical-environments">EnvironmentRecord</a></emu-xref>.</li><li>Let <var>result</var> be <emu-xref aoid="OrdinaryCallEvaluateBody"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ordinarycallevaluatebody">OrdinaryCallEvaluateBody</a></emu-xref>(<var>F</var>, <var>argumentsList</var>).</li><li>Remove <var>calleeContext</var> from the <emu-xref href="#sec-execution-contexts"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-execution-contexts">execution context</a></emu-xref> stack and restore <var>callerContext</var> as the running <emu-xref href="#sec-execution-contexts"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-execution-contexts">execution context</a></emu-xref>.</li><li>If <var>result</var>.[[type]] is <emu-const>return</emu-const>, then<ol><li>If <emu-xref aoid="Type"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>result</var>.[[value]]) is Object, return <emu-xref aoid="NormalCompletion"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-normalcompletion">NormalCompletion</a></emu-xref>(<var>result</var>.[[value]]).</li><li>If <var>kind</var> is <code>"base"</code>, return <emu-xref aoid="NormalCompletion"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-normalcompletion">NormalCompletion</a></emu-xref>(<var>thisArgument</var>).</li><li>If <var>result</var>.[[value]] is not <emu-val>undefined</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li></ol></li><li>Else, <emu-xref aoid="ReturnIfAbrupt"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-returnifabrupt">ReturnIfAbrupt</a></emu-xref>(<var>result</var>).</li><li>Return ? <var>envRec</var>.GetThisBinding().
  </li></ol></emu-alg>
</emu-clause>

<emu-clause id="sec-super-keyword">
  <h1><span class="secnum">2.4</span>The <code>super</code> Keyword<span class="utils"><span class="anchor"><a href="#sec-super-keyword">#</a></span></span></h1>

  <emu-clause id="sec-super-keyword-runtime-semantics-evaluation">
    <h1><span class="secnum">2.4.1</span>Runtime Semantics: Evaluation<span class="utils"><span class="anchor"><a href="#sec-super-keyword-runtime-semantics-evaluation">#</a></span></span></h1>

    <emu-grammar collapsed=""><emu-production name="SuperCall" id="prod-SuperCall">
    <emu-nt><a href="#prod-SuperCall">SuperCall</a></emu-nt><emu-geq>:</emu-geq><emu-rhs a="a833032f"><emu-t>super</emu-t><emu-nt><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#prod-Arguments">Arguments</a></emu-nt></emu-rhs>
</emu-production></emu-grammar>
    <emu-alg><ol><li>Let <var>newTarget</var> be <emu-xref aoid="GetNewTarget"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-getnewtarget">GetNewTarget</a></emu-xref>().</li><li>If <var>newTarget</var> is <emu-val>undefined</emu-val>, throw a <emu-val>ReferenceError</emu-val> exception.</li><li>Let <var>thisER</var> be <emu-xref aoid="GetThisEnvironment"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-getthisenvironment">GetThisEnvironment</a></emu-xref>().</li><li>Assert: <var>thisER</var> is a function <emu-xref href="#sec-environment-records"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-environment-records">Environment Record</a></emu-xref>.</li><li>Let <var>F</var> be <var>thisER</var>.[[FunctionObject]].</li><li>Assert: <var>F</var> is an ECMAScript function object.</li><li>Let <var>superConstructor</var> be ? <var>F</var>.[[GetPrototypeOf]]().</li><li>If <emu-xref aoid="IsConstructor"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-isconstructor">IsConstructor</a></emu-xref>(<var>superConstructor</var>) is <emu-val>false</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>argList</var> be ArgumentListEvaluation of <emu-nt><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#prod-Arguments">Arguments</a></emu-nt>.</li><li><emu-xref aoid="ReturnIfAbrupt"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-returnifabrupt">ReturnIfAbrupt</a></emu-xref>(<var>argList</var>).</li><li>Let <var>result</var> be ? <emu-xref aoid="Construct"><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-construct">Construct</a></emu-xref>(<var>superConstructor</var>, <var>argList</var>, <var>newTarget</var>).</li><li>Let <var>instanceSlots</var> be the value of <var>F</var>'s [[InstanceSlots]] internal slot.</li><li>Perform ! <emu-xref aoid="InitializeInternalSlots"><a href="#sec-initializeinternalslots">InitializeInternalSlots</a></emu-xref>(<var>result</var>, <var>instanceSlots</var>).</li><li>NOTE: Private field initializers should be evaluated here.</li><li>Return ? <var>thisER</var>.BindThisValue(<var>result</var>).
    </li></ol></emu-alg>

  </emu-clause>

</emu-clause>
</emu-import>
</emu-clause>
</body>